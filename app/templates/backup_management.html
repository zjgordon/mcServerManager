{% extends "base.html" %}

{% block title %}Backup Management - {{ app_title }}{% endblock %}

{% block content %}
<div class="backup-management-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="pixel-font-lg">
            <i class="fas fa-database"></i> Backup Management
        </h1>
        <p class="page-description">
            Manage automated backup schedules and view backup history for your Minecraft servers.
        </p>
    </div>

    <!-- Server Selection -->
    <div class="server-selection-section">
        <div class="card mc-card">
            <div class="card-header">
                <h3 class="pixel-font">
                    <i class="fas fa-server"></i> Select Server
                </h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="serverSelect" class="form-label">Choose a server to manage backups:</label>
                    <select id="serverSelect" class="form-control mc-input" onchange="loadServerBackupData()">
                        <option value="">-- Select a server --</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}" data-server-name="{{ server.server_name }}"
                                {% if selected_server_id and server.id == selected_server_id %}selected{% endif %}>
                            {{ server.server_name }} ({{ server.status }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Schedule Management -->
    <div id="scheduleSection" class="schedule-section" style="display: none;">
        <div class="card mc-card">
            <div class="card-header">
                <h3 class="pixel-font">
                    <i class="fas fa-clock"></i> Backup Schedule
                </h3>
            </div>
            <div class="card-body">
                <!-- Schedule Status -->
                <div id="scheduleStatus" class="schedule-status mb-4">
                    <div class="status-indicator">
                        <span class="status-icon">
                            <i class="fas fa-circle"></i>
                        </span>
                        <span class="status-text">Loading...</span>
                    </div>
                </div>

                <!-- Schedule Form -->
                <form id="scheduleForm" class="schedule-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="scheduleType" class="form-label">Schedule Type</label>
                                <select id="scheduleType" class="form-control mc-input" required>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="scheduleTime" class="form-label">Time</label>
                                <input type="time" id="scheduleTime" class="form-control mc-input" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="retentionDays" class="form-label">Retention (Days)</label>
                                <input type="number" id="retentionDays" class="form-control mc-input"
                                       min="1" max="365" value="30" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="enabled" class="form-check-input" checked>
                                    <label for="enabled" class="form-check-label">Enable Schedule</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="saveScheduleBtn" class="btn btn-mc">
                            <i class="fas fa-save"></i> Save Schedule
                        </button>
                        <button type="button" id="deleteScheduleBtn" class="btn btn-mc-danger" style="display: none;">
                            <i class="fas fa-trash"></i> Delete Schedule
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Manual Backup Section -->
    <div id="manualBackupSection" class="manual-backup-section" style="display: none;">
        <div class="card mc-card">
            <div class="card-header">
                <h3 class="pixel-font">
                    <i class="fas fa-play"></i> Manual Backup
                </h3>
            </div>
            <div class="card-body">
                <p>Create an immediate backup of the selected server.</p>
                <button id="triggerBackupBtn" class="btn btn-mc-warning">
                    <i class="fas fa-download"></i> Create Backup Now
                </button>
                <div id="backupProgress" class="backup-progress mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">Creating backup...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup History Section -->
    <div id="backupHistorySection" class="backup-history-section" style="display: none;">
        <div class="card mc-card">
            <div class="card-header">
                <h3 class="pixel-font">
                    <i class="fas fa-history"></i> Backup History
                </h3>
                <button id="refreshHistoryBtn" class="btn btn-sm btn-mc-secondary">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="backupHistoryTable" class="table-responsive">
                    <table class="table table-striped mc-table">
                        <thead>
                            <tr>
                                <th>Backup File</th>
                                <th>Size</th>
                                <th>Created</th>
                                <th>Age</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backupHistoryBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading backup history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="noBackupsMessage" class="no-backups-message text-center" style="display: none;">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h5>No Backups Found</h5>
                    <p class="text-muted">No backup files found for this server.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Status Updates -->
    <div id="statusUpdates" class="status-updates">
        <!-- Status updates will be inserted here -->
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p>Loading...</p>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content mc-modal">
            <div class="modal-header">
                <h5 class="modal-title pixel-font">Confirm Action</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" id="confirmAction" class="btn btn-mc-danger">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/backup-management.js') }}"></script>
{% endblock %}
